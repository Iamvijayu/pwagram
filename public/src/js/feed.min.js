var picture,fetchedLocation,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),locationInput=document.querySelector("#location"),titleInput=document.querySelector("#title"),videoPLayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader");locationBtn.addEventListener("click",e=>{e.preventDefault(),"geolocation"in navigator&&(locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(e=>{let t=e.coords.latitude,a=e.coords.longitude;console.log(t,a);var o=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${t}&lon=${a}&addressdetails=1`;fetch(o).then(e=>e.json()).then(e=>{let t=e.address.town+","+e.address.county+","+e.address.state;fetchedLocation=t,locationInput.value=fetchedLocation,locationInput.classList.add("is-focused"),locationBtn.style.display="none",locationLoader.style.display="none"}).catch(e=>{fetchedLocation=`LAT: ${t} LON: ${a}`,locationInput.value=fetchedLocation,locationInput.classList.add("is-focused"),locationBtn.style.display="none",locationLoader.style.display="none"})},e=>{locationBtn.style.display="inline",locationLoader.style.display="none",alert("Could't fetch location, please enter manually");snackBar.MaterialSnackbar.showSnackbar({message:"Could't fetch location, please enter manually"}),fetchedLocation=null},{timeout:7e3}))});var url="http://localhost:3000/",urlPost="https://httpbin.org/post",networkDataReceived=!1;function initializeLocation(){"geolocation"in navigator||(locationBtn.style.display="none",locationLoader.style.display="none")}function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(e){navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return getUserMedia?new Promise((t,a)=>{getUserMedia.call(navigator,e,t,a)}):Promise.reject(new Error("getUserMedia is not implemented!!!"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{videoPLayer.srcObject=e,videoPLayer.style.display="block",captureButton.style.display="block"}).catch(e=>{imagePickerArea.style.display="block"})}function openCreatePostModal(){setTimeout(()=>{createPostArea.style.transform="translateY(0)"},1),initializeMedia(),initializeLocation(),defereedPromptEvent&&(defereedPromptEvent.prompt(),defereedPromptEvent.userChoice.then(function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")}),defereedPromptEvent=null)}function closeCreatePostModal(){imagePickerArea.style.display="none",videoPLayer.style.display="none",canvasElement.style.display=" none",videoPLayer.srcObject&&videoPLayer.srcObject.getVideoTracks().forEach(e=>{e.stop()}),setTimeout(()=>{createPostArea.style.transform="translateY(100vh)"},1)}function sendData(e){var t=new FormData;t.append("id",e.id),t.append("title",e.title),t.append("location",e.location),t.append("image",e.image,e.id+".png"),fetch("http://pwagramserver-env.sinphsihnw.us-east-2.elasticbeanstalk.com/posts",{method:"POST",body:t}).then(t=>{console.log("Send Data Response",t),createCard(e)})}function onSaveButtonClicked(e){console.log("clicked"),"caches"in window&&caches.open("user-requested").then(function(e){e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")})}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp";var a=document.createElement("div");a.className="mdl-card__title",a.style.backgroundImage="url("+e.image+")",a.style.backgroundSize="cover",a.style.height="180px",t.appendChild(a);var o=document.createElement("h2");o.style.color="white",o.className="mdl-card__title-text",o.textContent=e.location,a.appendChild(o);var n=document.createElement("div");n.className="mdl-card__supporting-text",n.textContent=e.title,n.style.textAlign="center",t.appendChild(n),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function createCards(e){clearCards(),e.forEach(e=>{createCard(e)})}captureButton.addEventListener("click",e=>{canvasElement.style.display="block",videoPLayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPLayer,0,0,canvas.width,videoPLayer.videoHeight/(videoPLayer.videoWidth/canvas.width)),videoPLayer.srcObject.getVideoTracks().forEach(e=>{e.stop()}),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",e=>{picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal),form.addEventListener("submit",e=>{if(e.preventDefault(),""!==titleInput.value.trim()&&""!==locationInput.value.trim()&&null!=picture){closeCreatePostModal();var t={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,image:picture};"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(e=>{writeDatatoIndexDB("sync-posts",t).then(()=>e.sync.register("sync-new-post")).then(()=>{var e=document.querySelector("#confirmation-toast");titleInput.value="",locationInput.value="",e.MaterialSnackbar.showSnackbar({message:"You message was saved for syncing"})}).catch(e=>{console.log("Sync Error: ",e)})}):sendData(t)}else{alert("please enter a valid data (title & location) and capture the image properly");snackBar.MaterialSnackbar.showSnackbar({message:"please enter a valid data (title & location) and capture the image properly"})}}),fetch("http://pwagramserver-env.sinphsihnw.us-east-2.elasticbeanstalk.com/posts").then(function(e){return e.json()}).then(function(e){networkDataReceived=!0,dataArray=[];let t=e.posts;for(var a in t)dataArray.push(t[a]);createCards(dataArray)}).catch(e=>{}),"indexedDB"in window&&readAllData("posts").then(e=>{networkDataReceived||createCards(e)});